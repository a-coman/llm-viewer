---
interface Props {
  labels: string[];
  values: number[][];
  title?: string;
}

const { labels, values, title } = Astro.props;

function getColor(value: number): string {
  // value 0-1, Green 0.9, Red 0.5
  let score = (value - 0.5) / (0.9 - 0.5);
  score = Math.max(0, Math.min(1, score));
  const hue = score * 120; // 0 = red, 120 = green
  return `hsl(${hue}, 70%, 85%)`;
}
---

<div class="heatmap-container">
  {title && <h3 class="title">{title}</h3>}
  <div class="matrix-wrapper">
    <table class="matrix">
      <thead>
        <tr>
          <th></th>
          {labels.map((label) => <th class="col-header">{label}</th>)}
        </tr>
      </thead>
      <tbody>
        {
          values.map((row, i) => (
            <tr>
              <th class="row-header">{labels[i]}</th>
              {row.map((val, j) => (
                <td
                  class="cell"
                  style={`background-color: ${getColor(val)};`}
                  data-value={val.toFixed(3)}
                  data-row={labels[i]}
                  data-col={labels[j]}
                >
                  <span class="tooltip">
                    {labels[i]} â†” {labels[j]}: {val.toFixed(3)}
                  </span>
                </td>
              ))}
            </tr>
          ))
        }
      </tbody>
    </table>
  </div>
</div>

<style>
  .heatmap-container {
    overflow-x: auto;
  }

  .title {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--color-primary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.75rem;
  }

  .matrix-wrapper {
    overflow-x: auto;
    max-width: 100%;
  }

  .matrix {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.7rem;
  }

  .col-header {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    transform: rotate(180deg);
    padding: 0.5rem 0.25rem;
    font-weight: 500;
    color: var(--color-secondary);
  }

  .row-header {
    text-align: right;
    padding: 0.25rem 0.5rem;
    font-weight: 500;
    color: var(--color-secondary);
    white-space: nowrap;
  }

  .cell {
    aspect-ratio: 1;
    min-width: 20px;
    border: 1px solid var(--color-border-light);
    position: relative;
    cursor: pointer;
  }

  .tooltip {
    display: none;
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--color-accent);
    color: white;
    padding: 0.375rem 0.5rem;
    border-radius: 2px;
    font-size: 0.7rem;
    white-space: nowrap;
    z-index: 100;
    pointer-events: none;
  }

  .cell:hover .tooltip {
    display: block;
  }

  .tooltip::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-top-color: var(--color-accent);
  }
</style>
