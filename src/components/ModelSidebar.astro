---
interface Props {
  models: readonly string[];
  currentModel?: string;
  currentGen?: string;
  currentPage?: "dashboard" | "model" | "generation";
  showTabs?: boolean;
  activeTab?: "simple" | "cot";
  simpleGenCount?: number;
  cotGenCount?: number;
  experimentId?: string;
  experimentIds?: string[];
}

const {
  models,
  currentModel,
  currentGen,
  currentPage = "model",
  showTabs = true,
  activeTab = "simple",
  simpleGenCount = 30,
  cotGenCount = 6,
  experimentId = "",
  experimentIds = [],
} = Astro.props;

const simpleGens = Array.from(
  { length: simpleGenCount },
  (_, i) => `gen${i + 1}`
);
const cotGens = Array.from({ length: cotGenCount }, (_, i) => `gen${i + 1}`);
const showGens = currentModel || currentPage === "dashboard";
---

<aside class="sidebar" data-current-page={currentPage}>
  <div class="nav-header">
    <div class="experiment-selector">
      <select id="experiment-select" class="experiment-select">
        {
          experimentIds.map((id) => (
            <option value={id} selected={id === experimentId}>
              {id}
            </option>
          ))
        }
      </select>
    </div>
    <a
      href={`/${experimentId ? `?experimentId=${experimentId}` : ""}`}
      class:list={["nav-link", { active: currentPage === "dashboard" }]}
    >
      Dashboard
    </a>
  </div>

  {
    showTabs && (
      <div class="mode-selector">
        <button
          type="button"
          class:list={["mode-btn", { active: activeTab === "simple" }]}
          data-mode="simple"
        >
          Simple
        </button>
        <button
          type="button"
          class:list={["mode-btn", { active: activeTab === "cot" }]}
          data-mode="cot"
        >
          CoT
        </button>
      </div>
    )
  }

  {
    showGens && (
      <>
        <div
          class="gens-section"
          data-gens="simple"
          class:list={{ hidden: activeTab !== "simple" }}
        >
          <div class="section-header">
            <span class="section-title">Generations</span>
          </div>
          <ul class="gen-list">
            <li>
              <a
                href={
                  currentPage === "dashboard"
                    ? "#"
                    : `/models/${currentModel?.toLowerCase()}`
                }
                class:list={[
                  "gen-link",
                  "all-btn",
                  {
                    active:
                      currentPage !== "dashboard" &&
                      !currentGen &&
                      activeTab === "simple",
                  },
                ]}
                data-gen="all"
              >
                All
              </a>
            </li>
            {simpleGens.map((g) => (
              <li>
                <a
                  href={
                    currentPage === "dashboard"
                      ? "#"
                      : `/models/${currentModel?.toLowerCase()}/${g}`
                  }
                  class:list={[
                    "gen-link",
                    { active: currentGen === g && activeTab === "simple" },
                  ]}
                  data-gen={g}
                >
                  {g.replace("gen", "")}
                </a>
              </li>
            ))}
          </ul>
        </div>

        <div
          class="gens-section"
          data-gens="cot"
          class:list={{ hidden: activeTab !== "cot" }}
        >
          <div class="section-header">
            <span class="section-title">CoT Generations</span>
          </div>
          <ul class="gen-list">
            <li>
              <a
                href={
                  currentPage === "dashboard"
                    ? "#"
                    : `/models/${currentModel?.toLowerCase()}?type=cot`
                }
                class:list={[
                  "gen-link",
                  "all-btn",
                  {
                    active:
                      currentPage !== "dashboard" &&
                      !currentGen &&
                      activeTab === "cot",
                  },
                ]}
                data-gen="all"
              >
                All
              </a>
            </li>
            {cotGens.map((g) => (
              <li>
                <a
                  href={
                    currentPage === "dashboard"
                      ? "#"
                      : `/models/${currentModel?.toLowerCase()}/${g}?type=cot`
                  }
                  class:list={[
                    "gen-link",
                    { active: currentGen === g && activeTab === "cot" },
                  ]}
                  data-gen={g}
                >
                  {g.replace("gen", "")}
                </a>
              </li>
            ))}
          </ul>
        </div>
      </>
    )
  }

  <div class="models-section">
    <div class="section-title">Models</div>
    <nav>
      <ul>
        {
          models.map((model) => (
            <li>
              <a
                href={`/models/${model.toLowerCase()}`}
                class:list={[
                  "model-link",
                  {
                    active: currentModel?.toLowerCase() === model.toLowerCase(),
                  },
                ]}
                data-model={model.toLowerCase()}
              >
                {model}
              </a>
            </li>
          ))
        }
      </ul>
    </nav>
  </div>
</aside>

<style>
  .sidebar {
    width: 160px;
    flex-shrink: 0;
    background: var(--color-surface);
    border-right: 1px solid var(--color-border);
    height: 100vh;
    position: sticky;
    top: 0;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }

  .nav-header {
    padding: 0.75rem;
    border-bottom: 1px solid var(--color-border);
  }

  .nav-link {
    display: block;
    padding: 0.5rem 0.75rem;
    text-decoration: none;
    font-size: 0.8rem;
  }

  .experiment-selector {
    padding: 0 0.75rem 0.5rem;
  }

  .experiment-select {
    width: 100%;
    padding: 0.4rem;
    font-size: 0.75rem;
    background: var(--color-surface-hover);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    color: var(--color-text);
  }

  .mode-selector {
    display: flex;
    padding: 0.5rem;
    gap: 0.25rem;
    border-bottom: 1px solid var(--color-border);
  }

  .mode-btn {
    flex: 1;
    padding: 0.4rem 0.5rem;
    font-size: 0.75rem;
  }

  .gens-section {
    padding: 0.5rem;
    border-bottom: 1px solid var(--color-border);
  }
  .gens-section.hidden {
    display: none;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }
  .all-btn {
    font-weight: 500;
  }

  .gen-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(26px, 1fr));
    gap: 0.25rem;
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .gen-link {
    display: inline-block;
    width: 100%;
    line-height: 24px;
    text-align: center;
    font-size: 0.7rem;
    text-decoration: none;
    border-radius: 4px;
  }

  .models-section {
    flex: 1;
    padding: 0.75rem;
  }

  .section-title {
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
  }

  ul {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .model-link {
    display: block;
    padding: 0.35rem 0.5rem;
    text-decoration: none;
    font-size: 0.8rem;
  }

  @media (max-width: 768px) {
    .sidebar {
      width: 100%;
      height: auto;
      position: relative;
      flex-direction: row;
      flex-wrap: wrap;
    }
    .nav-header {
      border-bottom: none;
      border-right: 1px solid var(--color-border);
    }
    .models-section {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .models-section ul {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const sidebar = document.querySelector(".sidebar");
    const currentPage = sidebar?.getAttribute("data-current-page");
    const isDashboard = currentPage === "dashboard";
    const modeBtns = document.querySelectorAll(".mode-btn");
    const gensSections = document.querySelectorAll(".gens-section");
    const genLinks = document.querySelectorAll(".gen-link");
    const modelLinks = document.querySelectorAll(".model-link");
    const tabContents = document.querySelectorAll(".tab-content");

    // Get current mode from URL or active button
    const getCurrentMode = () =>
      document.querySelector(".mode-btn.active")?.getAttribute("data-mode") ||
      "simple";

    // Experiment selector
    const experimentSelect = document.getElementById("experiment-select");
    if (experimentSelect) {
      experimentSelect.addEventListener("change", (e) => {
        const id = (e.target as HTMLSelectElement).value;
        const url = new URL(window.location.href);
        url.searchParams.set("experimentId", id);
        window.location.href = url.toString();
      });
    }

    // Dashboard-specific behavior
    if (isDashboard) {
      genLinks.forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          const section = link.closest(".gens-section");
          section
            ?.querySelectorAll(".gen-link")
            .forEach((l) => l.classList.remove("active"));
          link.classList.add("active");
        });
      });
    }

    // Model links - preserve current gen, mode, and view when navigating
    modelLinks.forEach((link) => {
      link.addEventListener("click", (e) => {
        e.preventDefault();
        const modelName = link.getAttribute("data-model");
        const mode = getCurrentMode();
        const currentParams = new URLSearchParams(window.location.search);
        const currentView = currentParams.get("view");
        const experimentId = currentParams.get("experimentId");

        let url = `/models/${modelName}`;

        // Get current gen from URL path or from selected gen link (dashboard)
        let gen = "all";
        if (isDashboard) {
          const activeSection = document.querySelector(
            `.gens-section[data-gens="${mode}"]`
          );
          gen =
            activeSection
              ?.querySelector(".gen-link.active")
              ?.getAttribute("data-gen") || "all";
        } else {
          // On model/generation pages, get gen from current URL
          const genMatch = window.location.pathname.match(/gen(\d+)/);
          if (genMatch) gen = `gen${genMatch[1]}`;
        }

        // Append gen to URL if not "all"
        if (gen !== "all") url += `/${gen}`;

        // Build query params
        const params = new URLSearchParams();
        if (mode === "cot") params.set("type", "cot");
        if (currentView && currentView !== "instance-diagram")
          params.set("view", currentView);
        if (experimentId) params.set("experimentId", experimentId);

        if (params.toString()) url += `?${params.toString()}`;
        window.location.href = url;
      });
    });

    // Generation links - preserve view param when switching generations (non-dashboard)
    if (!isDashboard) {
      genLinks.forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          const href = link.getAttribute("href");
          if (!href || href === "#") return;

          const currentParams = new URLSearchParams(window.location.search);
          const currentView = currentParams.get("view");
          const experimentId = currentParams.get("experimentId");

          // Parse the existing href to get base path and any existing params
          const [basePath, existingQuery] = href.split("?");
          const params = new URLSearchParams(existingQuery || "");

          // Add view param if set
          if (currentView && currentView !== "instance-diagram") {
            params.set("view", currentView);
          }
          // Add experiment param
          if (experimentId) {
            params.set("experimentId", experimentId);
          }

          const url = params.toString()
            ? `${basePath}?${params.toString()}`
            : basePath;
          window.location.href = url;
        });
      });
    }

    // Helper to update gen link highlighting
    function updateGenHighlighting(mode: string) {
      if (isDashboard) return;

      // Get current gen from URL path
      const genMatch = window.location.pathname.match(/gen(\d+)/);
      const currentGen = genMatch ? `gen${genMatch[1]}` : null;

      // Clear all active states first
      genLinks.forEach((link) => link.classList.remove("active"));

      // Find the correct section and highlight the right link
      const targetSection = document.querySelector(
        `.gens-section[data-gens="${mode}"]`
      );
      if (targetSection) {
        if (currentGen) {
          targetSection
            .querySelector(`.gen-link[data-gen="${currentGen}"]`)
            ?.classList.add("active");
        } else {
          // On model page (no gen in URL), activate "All"
          targetSection
            .querySelector('.gen-link[data-gen="all"]')
            ?.classList.add("active");
        }
      }
    }

    // Mode switching
    modeBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        const mode = btn.getAttribute("data-mode") || "simple";
        modeBtns.forEach((b) => b.classList.toggle("active", b === btn));
        gensSections.forEach((s) =>
          s.classList.toggle("hidden", s.getAttribute("data-gens") !== mode)
        );
        tabContents.forEach((c) =>
          c.classList.toggle("active", c.getAttribute("data-content") === mode)
        );

        // Update gen link highlighting for the new mode
        updateGenHighlighting(mode);

        // Update URL param without reload (for non-dashboard pages)
        if (!isDashboard) {
          const url = new URL(window.location.href);
          mode === "cot"
            ? url.searchParams.set("type", "cot")
            : url.searchParams.delete("type");

          // Ensure experimentId is preserved (it should be, but just to be safe)
          const currentExpId = new URLSearchParams(window.location.search).get(
            "experimentId"
          );
          if (currentExpId && !url.searchParams.has("experimentId")) {
            // It works on existing URL so it should persist, but explicit check implies intention
          }

          window.history.replaceState({}, "", url.toString());
        }
      });
    });
  });
</script>

<script is:inline>
  (function () {
    try {
      const isCot =
        new URLSearchParams(window.location.search).get("type") === "cot";
      if (isCot) {
        // Switch mode buttons
        document
          .querySelector('.mode-btn[data-mode="simple"]')
          ?.classList.remove("active");
        document
          .querySelector('.mode-btn[data-mode="cot"]')
          ?.classList.add("active");
        // Switch generation sections
        document
          .querySelector('.gens-section[data-gens="simple"]')
          ?.classList.add("hidden");
        document
          .querySelector('.gens-section[data-gens="cot"]')
          ?.classList.remove("hidden");
        // Fix gen link highlighting - remove from simple, add to cot
        document
          .querySelectorAll('.gens-section[data-gens="simple"] .gen-link')
          .forEach((l) => l.classList.remove("active"));
        // Find current gen from URL path
        const genMatch = window.location.pathname.match(/gen(\d+)/);
        const cotSection = document.querySelector(
          '.gens-section[data-gens="cot"]'
        );
        if (genMatch) {
          cotSection
            ?.querySelector(`.gen-link[data-gen="gen${genMatch[1]}"]`)
            ?.classList.add("active");
        } else if (cotSection && !window.location.pathname.match(/gen\d+/)) {
          // On model page (no gen in URL), activate "All"
          cotSection
            .querySelector('.gen-link[data-gen="all"]')
            ?.classList.add("active");
        }
      }
    } catch (e) {}
  })();
</script>
