---
import PdfEmbed from "./PdfEmbed.astro";
import SoilViewer from "./SoilViewer.astro";
import MetricsPanel from "./MetricsPanel.astro";
import JudgeCard from "./JudgeCard.astro";

interface Props {
  data: any;
  label?: string;
  showJudge?: boolean;
  classDiagramPdf?: string;
}

const {
  data,
  label = "",
  showJudge = true,
  classDiagramPdf = "",
} = Astro.props;
const uniqueId = Math.random().toString(36).substring(2, 9);
---

<div class="content-grid wide-left">
  <div class="left-column">
    <section class="section diagram-section">
      <div class="diagram-header">
        <div class="diagram-tabs" data-tabs-id={uniqueId}>
          <button
            type="button"
            class="diagram-tab active"
            data-view="instance-diagram"
          >
            Instance Diagram
          </button>
          <button type="button" class="diagram-tab" data-view="instance-code">
            Instance Code
          </button>
          <button type="button" class="diagram-tab" data-view="class-diagram">
            Model Diagram
          </button>
        </div>
      </div>

      <div class="diagram-views" data-views-id={uniqueId}>
        <div class="diagram-view active" data-view-content="instance-diagram">
          <PdfEmbed
            src={data?.pdfUrl || ""}
            title="Instance Diagram"
            height="500px"
            available={data?.pdfAvailable ?? false}
          />
        </div>

        <div class="diagram-view" data-view-content="instance-code">
          {
            data?.code ? (
              <SoilViewer code={data.code} height="500px" />
            ) : (
              <div class="no-code">
                No code available {label && `for ${label}`}
              </div>
            )
          }
        </div>

        <div class="diagram-view" data-view-content="class-diagram">
          <PdfEmbed
            src={classDiagramPdf}
            title="Model Diagram"
            height="500px"
            available={!!classDiagramPdf}
          />
        </div>
      </div>
    </section>
  </div>

  <div class="right-column">
    {
      showJudge && data?.judge && (
        <section class="section">
          <JudgeCard response={data.judge.response} why={data.judge.why} />
        </section>
      )
    }
    <section class="section">
      <h2>Metrics</h2>
      <MetricsPanel metrics={data?.metrics} />
    </section>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Sync diagram tabs across all GenerationView instances
    function setAllDiagramTabs(viewName: string) {
      document.querySelectorAll(".diagram-tabs").forEach((tabsContainer) => {
        const tabsId = tabsContainer.getAttribute("data-tabs-id");
        const viewsContainer = document.querySelector(
          `.diagram-views[data-views-id="${tabsId}"]`
        );
        if (!viewsContainer) return;

        const tabs = tabsContainer.querySelectorAll(".diagram-tab");
        const views = viewsContainer.querySelectorAll(".diagram-view");

        tabs.forEach((t) =>
          t.classList.toggle("active", t.getAttribute("data-view") === viewName)
        );
        views.forEach((v) =>
          v.classList.toggle(
            "active",
            v.getAttribute("data-view-content") === viewName
          )
        );
      });
    }

    document.querySelectorAll(".diagram-tabs").forEach((tabsContainer) => {
      const tabs = tabsContainer.querySelectorAll(".diagram-tab");

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          const viewName = tab.getAttribute("data-view");
          if (viewName) {
            setAllDiagramTabs(viewName);
          }
        });
      });
    });
  });
</script>

<style>
  .left-column,
  .right-column {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    min-width: 0; /* Prevent flex children from overflowing grid */
    width: 100%;
  }

  .diagram-section {
    display: flex;
    flex-direction: column;
    --diagram-height: 500px;
    width: 100%;
  }

  .diagram-header {
    padding: 0.5rem 1rem;
    border-bottom: 1px solid #e0e0e0;
    background: #f5f5f5;
    display: flex;
    justify-content: center;
  }

  .diagram-tabs {
    display: flex;
    gap: 0.25rem;
    background: transparent;
    padding: 0.25rem;
  }

  .diagram-tab {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 500;
    color: #666;
    background: transparent;
    cursor: pointer;
    border: none;
    border-radius: 0;
    transition:
      background 0.15s ease,
      color 0.15s ease;
  }

  .diagram-tab:hover {
    background: #e5e5e5;
    color: #111;
  }

  .diagram-tab.active {
    background: #333;
    color: white;
  }

  .diagram-views {
    flex: 1;
    min-height: var(--diagram-height);
    width: 100%;
  }

  .diagram-view {
    display: none;
    height: var(--diagram-height);
    width: 100%;
  }

  .diagram-view.active {
    display: block;
  }

  /* Unified styles for all diagram view content */
  .diagram-view :global(.soil-viewer),
  .diagram-view :global(.pdf-container),
  .diagram-view :global(.unavailable) {
    border: none;
    border-radius: 0;
    height: var(--diagram-height);
    max-height: var(--diagram-height);
    min-height: var(--diagram-height);
    width: 100%;
  }

  .no-code {
    padding: 2rem;
    text-align: center;
    color: #888;
    font-style: italic;
    height: var(--diagram-height);
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8fafc;
  }
</style>
