---
import PdfEmbed from "./PdfEmbed.astro";
import SoilViewer from "./SoilViewer.astro";
import MetricsPanel from "./MetricsPanel.astro";
import JudgeCard from "./JudgeCard.astro";

interface Props {
  data: any;
  label?: string;
  showJudge?: boolean;
  classDiagramPdf?: string;
}

const {
  data,
  label = "",
  showJudge = true,
  classDiagramPdf = "",
} = Astro.props;
const uniqueId = Math.random().toString(36).substring(2, 9);

const code = data?.code || data?.metrics?.code;
const metrics = data?.metrics || data;
const pdfUrl = data?.pdfUrl || "";
const pdfAvailable = data?.pdfAvailable ?? !!pdfUrl;
---

<div class="content-grid">
  <section class="section diagram-section">
    <div class="diagram-header tabbed-header sober-header">
      <div class="header-label">View:</div>

      <div class="diagram-tabs" data-tabs-id={uniqueId}>
        <button
          type="button"
          class="diagram-tab active"
          data-view="instance-diagram"
        >
          Instance Diagram
        </button>
        <button type="button" class="diagram-tab" data-view="instance-code">
          Instance Code
        </button>
        <button type="button" class="diagram-tab" data-view="class-diagram">
          Model Diagram
        </button>
      </div>
    </div>

    <div class="diagram-views" data-views-id={uniqueId}>
      <div class="diagram-view active" data-view-content="instance-diagram">
        <PdfEmbed
          src={pdfUrl}
          title="Instance Diagram"
          height="500px"
          available={pdfAvailable}
        />
      </div>

      <div class="diagram-view" data-view-content="instance-code">
        {
          code ? (
            <SoilViewer code={code} height="500px" />
          ) : (
            <div class="sober-empty-state">
              <div class="sober-empty-text">No code available</div>
              <div class="sober-empty-hint">{label && `for ${label}`}</div>
            </div>
          )
        }
      </div>

      <div class="diagram-view" data-view-content="class-diagram">
        <PdfEmbed
          src={classDiagramPdf || ""}
          title="Model Diagram"
          height="500px"
          available={!!classDiagramPdf}
        />
      </div>
    </div>
  </section>

  <div class="metrics-column-wrapper">
    {
      showJudge && data?.judge && (
        <section class="section judge-section">
          <JudgeCard response={data.judge.response} why={data.judge.why} />
        </section>
      )
    }
    <div class="metrics-column">
      <MetricsPanel metrics={metrics} title="Metrics" />
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);
    const initialView = params.get("view") || "instance-diagram";

    function setAllDiagramTabs(viewName: string, updateUrl = true) {
      document.querySelectorAll(".diagram-tabs").forEach((tabsContainer) => {
        const tabsId = tabsContainer.getAttribute("data-tabs-id");
        const viewsContainer = document.querySelector(
          `.diagram-views[data-views-id="${tabsId}"]`
        );
        if (!viewsContainer) return;

        const tabs = tabsContainer.querySelectorAll(".diagram-tab");
        const views = viewsContainer.querySelectorAll("[data-view-content]");

        tabs.forEach((t) =>
          t.classList.toggle("active", t.getAttribute("data-view") === viewName)
        );
        views.forEach((v) =>
          v.classList.toggle(
            "active",
            v.getAttribute("data-view-content") === viewName
          )
        );
      });

      // Update URL with view parameter
      if (updateUrl) {
        const url = new URL(window.location.href);
        viewName === "instance-diagram"
          ? url.searchParams.delete("view")
          : url.searchParams.set("view", viewName);
        window.history.replaceState({}, "", url.toString());
      }
    }

    // Set initial view from URL
    setAllDiagramTabs(initialView, false);

    document.querySelectorAll(".diagram-tabs").forEach((tabsContainer) => {
      const tabs = tabsContainer.querySelectorAll(".diagram-tab");
      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          const viewName = tab.getAttribute("data-view");
          if (viewName) {
            setAllDiagramTabs(viewName);
          }
        });
      });
    });
  });
</script>

<script is:inline>
  (function () {
    try {
      const view = new URLSearchParams(window.location.search).get("view");
      if (view && view !== "instance-diagram") {
        document.querySelectorAll(".diagram-tab").forEach((t) => {
          t.classList.toggle("active", t.getAttribute("data-view") === view);
        });
        document.querySelectorAll("[data-view-content]").forEach((v) => {
          v.classList.toggle(
            "active",
            v.getAttribute("data-view-content") === view
          );
        });
      }
    } catch (e) {}
  })();
</script>

<style>
  .content-grid {
    align-items: start;
  }

  .diagram-section {
    margin: 0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .metrics-column-wrapper {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    min-width: 0;
  }

  .judge-section {
    margin-bottom: 0;
  }

  /* Alignment Fix: Make tabbed header match standard h2 padding/font */
  .diagram-header.tabbed-header {
    gap: 0.75rem;
  }

  .header-label {
    font-size: 0.75rem;
  }

  .diagram-tabs {
    display: flex;
    gap: 0.25rem;
    height: 1.75rem;
    align-items: center;
  }

  .diagram-tab {
    padding: 0 0.75rem;
    height: 100%;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    display: flex;
    align-items: center;
  }

  .diagram-views {
    flex: 1;
    height: 500px;
  }

  [data-view-content] {
    display: none;
    height: 100%;
    width: 100%;
  }

  [data-view-content].active {
    display: block;
  }
</style>
