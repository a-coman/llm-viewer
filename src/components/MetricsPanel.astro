---
import { getColor, formatPercent, formatCurrency } from "../lib/utils";

interface MetricStat {
  errors: number;
  total: number;
}

interface Metrics {
  syntax?: number | MetricStat;
  multiplicities?: number | MetricStat;
  invariants?: number | MetricStat;
  coverage?: {
    coverage: { classes: number; attributes: number; relationships: number };
    instantiation: {
      classes: number;
      attributes: number;
      relationships: number;
    };
  };
  diversity?: {
    numeric: number;
    stringEquals: number;
    stringLv: number;
  };
  judge?: { successRate: number };
  price?: { price: number };
  instantiation?: any;
  realism?: number;
}

interface Props {
  title?: string;
  metrics: Metrics | any;
  showSections?: {
    cost?: boolean;
    validation?: boolean;
    coverage?: boolean;
    instantiation?: boolean;
    diversity?: boolean;
    quality?: boolean;
  };
}

const {
  metrics,
  title,
  showSections = {
    cost: true,
    validation: true,
    coverage: true,
    instantiation: true,
    diversity: true,
    quality: true,
  },
} = Astro.props;

function getDisplayValue(
  val: any,
  type: "percent" | "count" | "currency" = "percent"
): { text: string; style: string } {
  if (val === undefined || val === null) return { text: "—", style: "" };

  if (type === "currency") {
    const price = typeof val === "object" ? val.price : val;
    return { text: formatCurrency(price), style: getColor(price, 10, 25) };
  }

  if (typeof val === "object" && "errors" in val) {
    const rate = val.total > 0 ? 1 - val.errors / val.total : 1;
    return {
      text: `${val.errors}/${val.total}`,
      style: getColor(rate, 0.95, 0.8),
    };
  }

  if (typeof val === "number") {
    if (type === "count")
      return { text: Math.round(val).toString(), style: "" };
    return { text: formatPercent(val), style: getColor(val, 0.95, 0.8) };
  }

  return { text: "—", style: "" };
}

const cov = metrics?.coverage?.coverage || metrics?.coverage;
const inst = metrics?.coverage?.instantiation || metrics?.instantiation;
const div = metrics?.diversity;
const judge = metrics?.judge || { successRate: metrics?.realism };
const price = metrics?.price;
---

<div class="metrics-panel">
  {title && <h2 class="sober-header">{title}</h2>}

  {
    showSections.cost &&
      (price !== undefined || metrics?.cost !== undefined) && (
        <div class="metric-section">
          <h3 class="sober-label">Cost</h3>

          <table class="metrics-table">
            <tbody>
              <tr>
                <td>Total Cost</td>
                <td
                  style={
                    getDisplayValue(price ?? metrics?.cost, "currency").style
                  }
                >
                  {getDisplayValue(price ?? metrics?.cost, "currency").text}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      )
  }

  {
    showSections.validation && (
      <div class="metric-section">
        <h3 class="sober-label">Validation</h3>

        <table class="metrics-table">
          <tbody>
            {["syntax", "multiplicities", "invariants"].map((key) => {
              const { text, style } = getDisplayValue(metrics?.[key]);
              const label = key.charAt(0).toUpperCase() + key.slice(1);
              return (
                <tr>
                  <td>{label}</td>
                  <td style={style}>{text}</td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    )
  }

  {
    showSections.coverage && cov && (
      <div class="metric-section">
        <h3 class="sober-label">Coverage</h3>

        <table class="metrics-table">
          <tbody>
            {Object.entries(cov).map(([key, val]) => {
              const { text, style } = getDisplayValue(val);
              const label = key.charAt(0).toUpperCase() + key.slice(1);
              return (
                <tr>
                  <td>{label}</td>
                  <td style={style}>{text}</td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    )
  }

  {
    showSections.instantiation && inst && (
      <div class="metric-section">
        <h3 class="sober-label">Instantiation</h3>

        <table class="metrics-table">
          <tbody>
            {Object.entries(inst).map(([key, val]) => {
              const { text } = getDisplayValue(val, "count");
              const label = key.charAt(0).toUpperCase() + key.slice(1);
              return (
                <tr>
                  <td>{label}</td>
                  <td>{text}</td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    )
  }

  {
    showSections.diversity && div && (
      <div class="metric-section">
        <h3 class="sober-label">Diversity</h3>

        <table class="metrics-table">
          <tbody>
            <tr>
              <td>Numeric</td>
              <td style={getDisplayValue(div.numeric).style}>
                {getDisplayValue(div.numeric).text}
              </td>
            </tr>
            <tr>
              <td>String Equals</td>
              <td style={getDisplayValue(div.stringEquals).style}>
                {getDisplayValue(div.stringEquals).text}
              </td>
            </tr>
            <tr>
              <td>String LV</td>
              <td style={getDisplayValue(div.stringLv).style}>
                {getDisplayValue(div.stringLv).text}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    )
  }

  {
    showSections.quality && judge && (
      <div class="metric-section">
        <h3 class="sober-label">Quality</h3>

        <table class="metrics-table">
          <tbody>
            <tr>
              <td>Realism</td>
              <td style={getDisplayValue(judge.successRate).style}>
                {getDisplayValue(judge.successRate).text}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    )
  }
</div>

<style>
  .metrics-panel {
    background: var(--color-background);
    border: 1px solid var(--color-border);
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .metric-section {
    border-bottom: 1px solid var(--color-border);
  }

  .metric-section:last-child {
    border-bottom: none;
  }

  .metrics-table {
    margin: 0;
  }
</style>
