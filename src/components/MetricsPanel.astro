---
interface Metrics {
  syntaxErrors?: number;
  syntaxTotal?: number;
  multiplicitiesErrors?: number;
  multiplicitiesTotal?: number;
  invariantsErrors?: number;
  invariantsTotal?: number;
  errors?: {
    syntaxErrors?: number;
    syntaxTotal?: number;
    multiplicitiesErrors?: number;
    multiplicitiesTotal?: number;
    invariantsErrors?: number;
    invariantsTotal?: number;
  };
  coverage?: {
    classes: number;
    attributes: number;
    relationships: number;
  };
  instantiation?: {
    classes: number;
    attributes: number;
    relationships: number;
  };
  diversity?: {
    numeric: number;
    stringEquals: number;
    stringLv: number;
  };
}

interface Props {
  metrics: Metrics | null;
  showInstantiation?: boolean;
  showDiversity?: boolean;
}

const { metrics, showInstantiation = true, showDiversity = true } = Astro.props;

function formatPercent(value: number): string {
  return `${(value * 100).toFixed(1)}%`;
}

// Get validation values - handle both flat and nested (errors) structures
function getValidationValue(
  metrics: Metrics,
  key: "syntax" | "multiplicities" | "invariants"
): { errors: number; total: number | null } {
  const errorsKey = `${key}Errors` as keyof Metrics;
  const totalKey = `${key}Total` as keyof Metrics;

  // Try flat structure first (from generation files)
  let errors = metrics[errorsKey] as number | undefined;
  let total = metrics[totalKey] as number | undefined;

  // Fall back to nested errors structure (from model files)
  if (errors === undefined && metrics.errors) {
    errors = metrics.errors[errorsKey as keyof typeof metrics.errors] as
      | number
      | undefined;
    total = metrics.errors[totalKey as keyof typeof metrics.errors] as
      | number
      | undefined;
  }

  return { errors: errors ?? 0, total: total ?? null };
}
---

{
  metrics ? (
    <>
      <h3>Validation</h3>
      <table class="validation-table">
        <tbody>
          {(() => {
            const syntax = getValidationValue(metrics, "syntax");
            const mult = getValidationValue(metrics, "multiplicities");
            const inv = getValidationValue(metrics, "invariants");

            return (
              <>
                <tr class={syntax.errors === 0 ? "ok" : "error"}>
                  <td>Syntax</td>
                  <td>
                    {syntax.errors === 0
                      ? syntax.total !== null
                        ? `0/${syntax.total}`
                        : "0"
                      : syntax.total !== null
                        ? `${syntax.errors}/${syntax.total}`
                        : `${syntax.errors} errors`}
                  </td>
                </tr>
                <tr class={mult.errors === 0 ? "ok" : "error"}>
                  <td>Multiplicities</td>
                  <td>
                    {mult.errors === 0
                      ? mult.total !== null
                        ? `0/${mult.total}`
                        : "0"
                      : mult.total !== null
                        ? `${mult.errors}/${mult.total}`
                        : `${mult.errors} errors`}
                  </td>
                </tr>
                <tr class={inv.errors === 0 ? "ok" : "error"}>
                  <td>Invariants</td>
                  <td>
                    {inv.errors === 0
                      ? inv.total !== null
                        ? `0/${inv.total}`
                        : "0"
                      : inv.total !== null
                        ? `${inv.errors}/${inv.total}`
                        : `${inv.errors} errors`}
                  </td>
                </tr>
              </>
            );
          })()}
        </tbody>
      </table>

      {metrics.coverage && (
        <>
          <h3>Coverage</h3>
          <table class="metrics-table">
            <tbody>
              <tr>
                <td>Classes</td>
                <td>{formatPercent(metrics.coverage.classes)}</td>
              </tr>
              <tr>
                <td>Attributes</td>
                <td>{formatPercent(metrics.coverage.attributes)}</td>
              </tr>
              <tr>
                <td>Relationships</td>
                <td>{formatPercent(metrics.coverage.relationships)}</td>
              </tr>
            </tbody>
          </table>
        </>
      )}

      {showInstantiation && metrics.instantiation && (
        <>
          <h3>Instantiation</h3>
          <table class="metrics-table">
            <tbody>
              <tr>
                <td>Classes</td>
                <td>{metrics.instantiation.classes}</td>
              </tr>
              <tr>
                <td>Attributes</td>
                <td>{metrics.instantiation.attributes}</td>
              </tr>
              <tr>
                <td>Relationships</td>
                <td>{metrics.instantiation.relationships}</td>
              </tr>
            </tbody>
          </table>
        </>
      )}

      {showDiversity && metrics.diversity && (
        <>
          <h3>Diversity</h3>
          <table class="metrics-table">
            <tbody>
              <tr>
                <td>Numeric</td>
                <td>{formatPercent(metrics.diversity.numeric)}</td>
              </tr>
              <tr>
                <td>String Equals</td>
                <td>{formatPercent(metrics.diversity.stringEquals)}</td>
              </tr>
              <tr>
                <td>String LV</td>
                <td>{formatPercent(metrics.diversity.stringLv)}</td>
              </tr>
            </tbody>
          </table>
        </>
      )}
    </>
  ) : (
    <p class="no-data">No metrics available</p>
  )
}
