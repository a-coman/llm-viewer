---
interface Props {
  label: string;
  value: string | number | undefined | null;
  type?: "percentage" | "currency" | "number";
  invertColor?: boolean;
  icon?: string;
}

const {
  label,
  value,
  type = "percentage",
  invertColor = false,
  icon,
} = Astro.props;

// Check if value is missing
const isMissing =
  value === undefined ||
  value === null ||
  (typeof value === "number" && isNaN(value));

function getColor(val: number, invert: boolean): string {
  let score = val;
  if (type === "percentage") {
    score = typeof val === "string" ? parseFloat(String(val)) / 100 : val;
  } else if (type === "currency") {
    // For currency, lower is better: 0€ = green, 100€ = red
    score = Math.max(0, Math.min(1, 1 - val / 100));
  }

  if (invert) score = 1 - score;
  score = Math.max(0, Math.min(1, score));

  const hue = score <= 0.5 ? 0 : (score - 0.5) * 2 * 120;
  return `hsl(${hue}, 75%, 90%)`;
}

function formatValue(
  val: string | number | undefined | null,
  t: string
): string {
  if (isMissing) return "—";
  if (t === "percentage") {
    const num = typeof val === "number" ? val : parseFloat(String(val));
    return `${(num * 100).toFixed(1)}%`;
  }
  if (t === "currency") {
    return `$${typeof val === "number" ? val.toFixed(2) : val}`;
  }
  return String(val);
}

const numericValue = isMissing
  ? 0
  : typeof value === "number"
    ? value
    : parseFloat(String(value)) || 0;
const bgColor = isMissing ? "#f1f5f9" : getColor(numericValue, invertColor);
const displayValue = formatValue(value, type);
---

<div
  class="metric-card"
  class:list={{ missing: isMissing }}
  style={`background-color: ${bgColor};`}
>
  {icon && <span class="icon">{icon}</span>}
  <div class="content">
    <span class="value">{displayValue}</span>
    <span class="label">{label}</span>
  </div>
</div>

<style>
  .metric-card {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    border-radius: 0.5rem;
    border: 1px solid #e2e8f0;
    min-width: 140px;
  }

  .icon {
    font-size: 1.5rem;
  }

  .content {
    display: flex;
    flex-direction: column;
  }

  .value {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1e293b;
  }

  .label {
    font-size: 0.75rem;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .metric-card.missing {
    border-style: dashed;
    border-color: #cbd5e1;
  }

  .metric-card.missing .value {
    color: #94a3b8;
  }
</style>
