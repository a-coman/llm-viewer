---
import PageLayout from "../../../layouts/PageLayout.astro";
import GenerationView from "../../../components/GenerationView.astro";
import { MODELS_LOWER, COT_CATEGORIES } from "../../../lib/constants";
import { getModelName } from "../../../lib/utils";
import { getModelData, getExperimentIds } from "../../../lib/data";

export function getStaticPaths() {
  const experimentIds = getExperimentIds();
  const paths: {
    params: { experiment: string; model: string; gen: string };
  }[] = [];
  for (const experiment of experimentIds) {
    for (const model of MODELS_LOWER) {
      for (let i = 1; i <= 30; i++) {
        paths.push({ params: { experiment, model, gen: `gen${i}` } });
      }
    }
  }
  return paths;
}

const { experiment, model, gen } = Astro.params;
const modelName = getModelName(model || "");
const genNum = parseInt(gen?.replace("gen", "") || "0");
const experimentIds = getExperimentIds();

// Load centralized data
const modelData = getModelData(model || "", experiment);
const simpleData = modelData?.simple.generations.find((g) => g.id === gen);
const cotData = modelData?.cot.generations.find((g) => g.id === gen);
const classDiagramPdf = modelData?.diagramPdf || "";
const classDiagramUseCode = modelData?.diagramUseCode || "";

const hasCotData = genNum <= 30 && !!cotData;
---

<PageLayout
  title={`${modelName} / ${gen}`}
  currentModel={modelName}
  currentGen={gen}
  currentPage="generation"
  activeTab="simple"
  experimentId={experiment}
  experimentIds={experimentIds}
>
  <Fragment slot="header-right">
    {
      hasCotData && (
        <div class="category-tabs hidden" data-nav="cot">
          {COT_CATEGORIES.map((cat) => (
            <button type="button" class="cat-tab" data-cat={cat}>
              {cat}
            </button>
          ))}
        </div>
      )
    }
  </Fragment>

  {
    !simpleData && !cotData ? (
      <div class="error-state">
        <p>
          No data available for:{" "}
          <strong>
            {modelName} / {gen}
          </strong>
        </p>
        <p>
          Run: <code>npm run preprocess</code>
        </p>
      </div>
    ) : (
      <>
        {/* Simple Content */}
        <div class="tab-content active" data-content="simple">
          <GenerationView
            data={simpleData}
            classDiagramPdf={classDiagramPdf}
            classDiagramUseCode={classDiagramUseCode}
            systemPrompt={simpleData?.systemPrompt}
            userPrompt={simpleData?.userPrompt}
          />
        </div>

        {/* CoT Content */}
        {hasCotData && (
          <div class="tab-content" data-content="cot">
            {COT_CATEGORIES.map((cat) => {
              const catData = cotData?.categories?.find(
                (c: any) => c.category === cat,
              );
              return (
                <div class="cat-content" data-cat-content={cat}>
                  <GenerationView
                    data={catData}
                    label={cat}
                    classDiagramPdf={classDiagramPdf}
                    classDiagramUseCode={classDiagramUseCode}
                    cotPrompts={catData?.prompts}
                  />
                </div>
              );
            })}
          </div>
        )}
      </>
    )
  }
</PageLayout>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const modeBtns = document.querySelectorAll(".mode-btn");
    const contents = document.querySelectorAll(".tab-content[data-content]");
    const navs = document.querySelectorAll(".category-tabs[data-nav]");
    const gensSections = document.querySelectorAll(".gens-section");
    const catTabs = document.querySelectorAll(".cat-tab[data-cat]");
    const catContents = document.querySelectorAll(
      ".cat-content[data-cat-content]",
    );

    const params = new URLSearchParams(window.location.search);
    const initialTab = params.get("type") || "simple";
    const initialCategory = params.get("category") || "baseline";

    function setTab(tabName: string) {
      document.documentElement.setAttribute("data-mode", tabName);
      modeBtns.forEach((btn) =>
        btn.classList.toggle(
          "active",
          btn.getAttribute("data-mode") === tabName,
        ),
      );
      contents.forEach((c) =>
        c.classList.toggle(
          "active",
          c.getAttribute("data-content") === tabName,
        ),
      );
      navs.forEach((n) => n.classList.toggle("hidden", tabName !== "cot"));
      gensSections.forEach((s) =>
        s.classList.toggle("hidden", s.getAttribute("data-gens") !== tabName),
      );

      const url = new URL(window.location.href);
      if (tabName === "simple") {
        url.searchParams.delete("type");
        url.searchParams.delete("category"); // Remove category when switching to simple
        url.searchParams.delete("agent"); // Remove agent when switching to simple
      } else {
        url.searchParams.set("type", tabName);
      }
      window.history.replaceState({}, "", url.toString());
      window.dispatchEvent(new CustomEvent("sync-gen-view"));
    }

    function setCategory(catName: string) {
      catTabs.forEach((t) =>
        t.classList.toggle("active", t.getAttribute("data-cat") === catName),
      );
      catContents.forEach((c) =>
        c.classList.toggle(
          "active",
          c.getAttribute("data-cat-content") === catName,
        ),
      );

      // Update URL with category param
      const url = new URL(window.location.href);
      if (catName === "baseline") {
        url.searchParams.delete("category"); // baseline is default, no need to show in URL
      } else {
        url.searchParams.set("category", catName);
      }
      window.history.replaceState({}, "", url.toString());
      window.dispatchEvent(new CustomEvent("sync-gen-view"));
    }

    setTab(initialTab);
    if (initialTab === "cot") {
      setCategory(initialCategory);
    }

    modeBtns.forEach((btn) =>
      btn.addEventListener("click", () => {
        const mode = btn.getAttribute("data-mode") || "simple";
        setTab(mode);
        // When switching to CoT, apply current category from URL or default
        if (mode === "cot") {
          const currentCategory =
            new URLSearchParams(window.location.search).get("category") ||
            "baseline";
          setCategory(currentCategory);
        }
      }),
    );

    // Category switching
    catTabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        const cat = tab.getAttribute("data-cat");
        if (cat) setCategory(cat);
      });
    });
  });
</script>

<script is:inline>
  (function () {
    try {
      const params = new URLSearchParams(window.location.search);
      const isCot = params.get("type") === "cot";
      const category = params.get("category") || "baseline";

      if (isCot) {
        document
          .querySelector('.tab-content[data-content="simple"]')
          ?.classList.remove("active");
        document
          .querySelector('.tab-content[data-content="cot"]')
          ?.classList.add("active");
        document
          .querySelector('.category-tabs[data-nav="cot"]')
          ?.classList.remove("hidden");

        // Set active category
        document.querySelectorAll(".cat-tab").forEach((tab) => {
          tab.classList.toggle(
            "active",
            tab.getAttribute("data-cat") === category,
          );
        });
        document.querySelectorAll(".cat-content").forEach((content) => {
          content.classList.toggle(
            "active",
            content.getAttribute("data-cat-content") === category,
          );
        });
      } else {
        // Simple mode: set default category for when switching to CoT
        document
          .querySelector('.cat-tab[data-cat="baseline"]')
          ?.classList.add("active");
        document
          .querySelector('.cat-content[data-cat-content="baseline"]')
          ?.classList.add("active");
      }
    } catch (e) {}
  })();
</script>
