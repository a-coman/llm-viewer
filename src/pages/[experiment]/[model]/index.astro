---
import PageLayout from "../../../layouts/PageLayout.astro";
import GedHeatmap from "../../../components/GedHeatmap.astro";
import DataTable from "../../../components/DataTable.astro";
import MetricsPanel from "../../../components/MetricsPanel.astro";
import { MODELS_LOWER, COLOR_RANGES } from "../../../lib/constants";
import { getModelName } from "../../../lib/utils";
import { getModelData, getExperimentIds } from "../../../lib/data";
import Tooltip from "../../../components/Tooltip.astro";

export async function getStaticPaths() {
  const experimentIds = getExperimentIds();
  const paths: { params: { experiment: string; model: string } }[] = [];
  for (const experiment of experimentIds) {
    for (const model of MODELS_LOWER) {
      paths.push({ params: { experiment, model } });
    }
  }
  return paths;
}

const { experiment, model } = Astro.params;
const modelName = getModelName(model || "");
const experimentIds = getExperimentIds();

const modelData = getModelData(model || "", experiment);

const simpleData = modelData?.simple || null;
const cotData = modelData?.cot || null;

const modelPanelSections = {
  cost: true,
  validation: true,
  coverage: true,
  instantiation: true,
  diversity: true,
  quality: true,
};
---

<PageLayout
  title={modelName}
  currentModel={modelName}
  currentPage="model"
  activeTab="simple"
  experimentId={experiment}
  experimentIds={experimentIds}
>
  {
    !modelData ? (
      <div class="error-state">
        <p>
          No data available for model: <strong>{modelName}</strong>
        </p>
        <p>
          Run: <code>npm run preprocess</code>
        </p>
      </div>
    ) : (
      <>
        {/* Simple Content */}
        <div class="tab-content active" data-content="simple">
          <div class="content-grid">
            <section class="section">
              <h2>GED Similarity
                <Tooltip metricType="ged" />
              </h2>
              {simpleData?.gedHeatmap ? (
                <GedHeatmap data={simpleData.gedHeatmap} />
              ) : (
                <div class="sober-empty-state">
                  <span class="sober-empty-text">No GED Data</span>
                </div>
              )}
            </section>

            <div class="metrics-column">
              <MetricsPanel
                title={`${modelName} - Simple Metrics`}
                metrics={simpleData}
                showSections={modelPanelSections}
                priceRange={COLOR_RANGES.price.model}
              />
            </div>
          </div>

          <section class="section">
            <h2>Generations</h2>
            {simpleData?.generations ? (
              <DataTable
                data={simpleData.generations}
                type="generations"
                modelSlug={model}
                experimentId={experiment}
              />
            ) : (
              <p class="no-data">No generation data available</p>
            )}
          </section>
        </div>

        {/* CoT Content */}
        <div class="tab-content" data-content="cot">
          <div class="content-grid">
            <section class="section">
              <h2>GED Similarity
                <Tooltip metricType="ged" />
              </h2>
              {cotData?.gedHeatmap ? (
                <GedHeatmap data={cotData.gedHeatmap} />
              ) : (
                <div class="sober-empty-state">
                  <span class="sober-empty-text">No GED Data</span>
                </div>
              )}
            </section>

            <div class="metrics-column">
              <MetricsPanel
                title={`${modelName} - CoT Metrics`}
                metrics={cotData}
                showSections={modelPanelSections}
                priceRange={COLOR_RANGES.price.model}
              />
            </div>
          </div>

          <section class="section">
            <h2>Generations</h2>
            {cotData?.generations ? (
              <DataTable
                data={cotData.generations}
                type="generations"
                modelSlug={model}
                genType="cot"
                experimentId={experiment}
              />
            ) : (
              <p class="no-data">No generation data available</p>
            )}
          </section>
        </div>
      </>
    )
  }
</PageLayout>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const modeBtns = document.querySelectorAll(".mode-btn");
    const contents = document.querySelectorAll(".tab-content[data-content]");
    const params = new URLSearchParams(window.location.search);
    const initialTab = params.get("type") || "simple";

    function setTab(tabName: string) {
      document.documentElement.setAttribute("data-mode", tabName);
      modeBtns.forEach((btn) =>
        btn.classList.toggle(
          "active",
          btn.getAttribute("data-mode") === tabName,
        ),
      );
      contents.forEach((c) =>
        c.classList.toggle(
          "active",
          c.getAttribute("data-content") === tabName,
        ),
      );
      const url = new URL(window.location.href);
      tabName === "simple"
        ? url.searchParams.delete("type")
        : url.searchParams.set("type", tabName);
      window.history.replaceState({}, "", url.toString());
    }

    setTab(initialTab);
    modeBtns.forEach((btn) =>
      btn.addEventListener("click", () =>
        setTab(btn.getAttribute("data-mode") || "simple"),
      ),
    );
  });
</script>

<style>
  @media (max-width: 1024px) {
    .content-grid {
      grid-template-columns: 1fr;
    }
  }

  .content-grid > .section {
    height: 100%;
    margin-bottom: 0;
    display: flex;
    flex-direction: column;
    min-height: 0; /* Allow inner content to shrink if needed */
  }

  /* Ensure the heatmap adapts to the flex container */
  .content-grid > .section > :global(.heatmap-container) {
    flex: 1;
    min-height: 0;
  }
</style>
