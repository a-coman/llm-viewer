---
import PageLayout from "../../layouts/PageLayout.astro";
import HeatmapMatrix from "../../components/HeatmapMatrix.astro";
import PdfEmbed from "../../components/PdfEmbed.astro";
import DataTable from "../../components/DataTable.astro";
import MetricsPanel from "../../components/MetricsPanel.astro";
import { MODELS_LOWER } from "../../lib/constants";
import { getModelName } from "../../lib/utils";
import { getModelData } from "../../lib/data";

export async function getStaticPaths() {
  return MODELS_LOWER.map((model) => ({ params: { model } }));
}

const { model } = Astro.params;
const modelName = getModelName(model || "");
const modelData = getModelData(model || "");

const simpleData = modelData?.simple || null;
const cotData = modelData?.cot || null;

const modelPanelSections = {
  cost: true,
  validation: true,
  coverage: true,
  instantiation: false,
  diversity: true,
  quality: true,
};
---

<PageLayout
  title={modelName}
  currentModel={modelName}
  currentPage="model"
  activeTab="simple"
>
  {
    !modelData ? (
      <div class="error-state">
        <p>
          No data available for model: <strong>{modelName}</strong>
        </p>
        <p>
          Run: <code>npm run preprocess</code>
        </p>
      </div>
    ) : (
      <>
        {/* Simple Content */}
        <div class="tab-content active" data-content="simple">
          <div class="content-grid">
            <section class="section">
              <h2>Model Diagram</h2>
              <PdfEmbed
                src={modelData.diagramPdf}
                title="Model Diagram"
                height="500px"
                available={true}
              />
            </section>

            <div class="metrics-column">
              <MetricsPanel
                title={`${modelName} - Simple Metrics`}
                metrics={simpleData}
                showSections={modelPanelSections}
              />
            </div>
          </div>

          {simpleData?.grakel && simpleData.grakel.values?.length > 0 && (
            <section class="section">
              <h2>Grakel Similarity</h2>
              <HeatmapMatrix
                labels={simpleData.grakel.labels}
                values={simpleData.grakel.values}
              />
            </section>
          )}

          <section class="section">
            <h2>Generations</h2>
            {simpleData?.generations ? (
              <DataTable
                data={simpleData.generations}
                type="generations"
                modelSlug={model}
              />
            ) : (
              <p class="no-data">No generation data available</p>
            )}
          </section>
        </div>

        {/* CoT Content */}
        <div class="tab-content" data-content="cot">
          <div class="content-grid">
            <section class="section">
              <h2>Model Diagram</h2>
              <PdfEmbed
                src={modelData.diagramPdf}
                title="Model Diagram"
                height="500px"
                available={true}
              />
            </section>

            <div class="metrics-column">
              <MetricsPanel
                title={`${modelName} - CoT Metrics`}
                metrics={cotData}
                showSections={modelPanelSections}
              />
            </div>
          </div>

          {cotData?.grakel && cotData.grakel.values?.length > 0 && (
            <section class="section">
              <h2>Grakel Similarity</h2>
              <HeatmapMatrix
                labels={cotData.grakel.labels}
                values={cotData.grakel.values}
              />
            </section>
          )}

          <section class="section">
            <h2>Generations</h2>
            {cotData?.generations ? (
              <DataTable
                data={cotData.generations}
                type="generations"
                modelSlug={model}
                genType="cot"
              />
            ) : (
              <p class="no-data">No generation data available</p>
            )}
          </section>
        </div>
      </>
    )
  }
</PageLayout>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const modeBtns = document.querySelectorAll(".mode-btn");
    const contents = document.querySelectorAll(".tab-content[data-content]");
    const params = new URLSearchParams(window.location.search);
    const initialTab = params.get("type") || "simple";

    function setTab(tabName: string) {
      modeBtns.forEach((btn) =>
        btn.classList.toggle(
          "active",
          btn.getAttribute("data-mode") === tabName
        )
      );
      contents.forEach((c) =>
        c.classList.toggle("active", c.getAttribute("data-content") === tabName)
      );
      const url = new URL(window.location.href);
      tabName === "simple"
        ? url.searchParams.delete("type")
        : url.searchParams.set("type", tabName);
      window.history.replaceState({}, "", url.toString());
    }

    setTab(initialTab);
    modeBtns.forEach((btn) =>
      btn.addEventListener("click", () =>
        setTab(btn.getAttribute("data-mode") || "simple")
      )
    );
  });
</script>

<style>
  @media (max-width: 1024px) {
    .content-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
