---
import PageLayout from "../../components/PageLayout.astro";
import HeatmapMatrix from "../../components/HeatmapMatrix.astro";
import ShannonBars from "../../components/ShannonBars.astro";
import PdfEmbed from "../../components/PdfEmbed.astro";
import {
  MODELS_LOWER,
  COT_CATEGORIES,
  getModelName,
  getColor,
  formatPercent,
  formatCurrency,
} from "../../lib/constants";

export function getStaticPaths() {
  return MODELS_LOWER.map((model) => ({ params: { model } }));
}

const { model } = Astro.params;
const modelName = getModelName(model);

// Load model data
let modelData: any = null;
try {
  modelData = await import(`../../data/processed/models/${model}.json`);
  modelData = modelData.default || modelData;
} catch (e) {
  console.error(`Failed to load model data for ${model}:`, e);
}

const simpleData = modelData?.simple || null;
const cotData = modelData?.cot || null;

// Helper to calculate validation rates
function getValidationRate(generations: any[], errorKey: string): string {
  if (!generations?.length) return "—";
  const successCount = generations.filter(
    (g: any) => (g.metrics?.[errorKey] || 0) === 0
  ).length;
  return `${((successCount / generations.length) * 100).toFixed(1)}%`;
}

// Helper to calculate average coverage
function getAvgCoverage(gen: any): number {
  const c = gen.metrics?.coverage;
  return c ? (c.classes + c.attributes + c.relationships) / 3 : 0;
}
---

<PageLayout
  title={modelName}
  currentModel={modelName}
  currentPage="model"
  activeTab="simple"
>
  {
    !modelData ? (
      <div class="error-state">
        <p>
          No data available for model: <strong>{modelName}</strong>
        </p>
        <p>
          Run: <code>npm run preprocess</code>
        </p>
      </div>
    ) : (
      <>
        {/* Simple Content */}
        <div class="tab-content active" data-content="simple">
          <div class="content-grid">
            <section class="section">
              <h2>Class Diagram</h2>
              <PdfEmbed
                src={modelData.diagramPdf}
                title="Class Diagram"
                available={true}
              />
            </section>

            <section class="section">
              <h2>Metrics</h2>
              <table class="metrics-table">
                <tbody>
                  <tr>
                    <>
                      <td>Cost</td>
                      <td>${simpleData?.price?.price?.toFixed(2) || "—"}</td>
                    </>
                  </tr>
                  <tr>
                    <>
                      <td>Syntax</td>
                      <td>
                        {getValidationRate(
                          simpleData?.generations,
                          "syntaxErrors"
                        )}
                      </td>
                    </>
                  </tr>
                  <tr>
                    <>
                      <td>Multiplicities</td>
                      <td>
                        {getValidationRate(
                          simpleData?.generations,
                          "multiplicitiesErrors"
                        )}
                      </td>
                    </>
                  </tr>
                  <tr>
                    <>
                      <td>Invariants</td>
                      <td>
                        {getValidationRate(
                          simpleData?.generations,
                          "invariantsErrors"
                        )}
                      </td>
                    </>
                  </tr>
                </tbody>
              </table>

              <h3>Coverage</h3>
              <table class="metrics-table">
                <tbody>
                  <tr>
                    <>
                      <td>Classes</td>
                      <td>
                        {simpleData?.coverage?.classes
                          ? formatPercent(simpleData.coverage.classes)
                          : "—"}
                      </td>
                    </>
                  </tr>
                  <tr>
                    <>
                      <td>Attributes</td>
                      <td>
                        {simpleData?.coverage?.attributes
                          ? formatPercent(simpleData.coverage.attributes)
                          : "—"}
                      </td>
                    </>
                  </tr>
                  <tr>
                    <>
                      <td>Relationships</td>
                      <td>
                        {simpleData?.coverage?.relationships
                          ? formatPercent(simpleData.coverage.relationships)
                          : "—"}
                      </td>
                    </>
                  </tr>
                  <tr>
                    <>
                      <td>Realism</td>
                      <td>
                        {simpleData?.judge?.successRate
                          ? formatPercent(simpleData.judge.successRate)
                          : "—"}
                      </td>
                    </>
                  </tr>
                </tbody>
              </table>

              <h3>Diversity</h3>
              <table class="metrics-table">
                <tbody>
                  <tr>
                    <>
                      <td>Numeric</td>
                      <td>
                        {simpleData?.diversity?.numeric
                          ? formatPercent(simpleData.diversity.numeric)
                          : "—"}
                      </td>
                    </>
                  </tr>
                  <tr>
                    <>
                      <td>String Equals</td>
                      <td>
                        {simpleData?.diversity?.stringEquals
                          ? formatPercent(simpleData.diversity.stringEquals)
                          : "—"}
                      </td>
                    </>
                  </tr>
                  <tr>
                    <>
                      <td>String LV</td>
                      <td>
                        {simpleData?.diversity?.stringLv
                          ? formatPercent(simpleData.diversity.stringLv)
                          : "—"}
                      </td>
                    </>
                  </tr>
                </tbody>
              </table>
            </section>
          </div>

          {simpleData?.grakel?.values?.length > 0 && (
            <section class="section">
              <h2>Grakel Similarity</h2>
              <HeatmapMatrix
                labels={simpleData.grakel.labels}
                values={simpleData.grakel.values}
              />
            </section>
          )}

          {simpleData?.shannon?.length > 0 && (
            <section class="section">
              <h2>Shannon Entropy</h2>
              <ShannonBars data={simpleData.shannon} />
            </section>
          )}

          <section class="section">
            <h2>Generations</h2>
            {simpleData?.generations ? (
              <div class="table-wrapper">
                <table class="gen-table">
                  <thead>
                    <tr>
                      <th>Gen</th>
                      <th>Syntax</th>
                      <th>Mult</th>
                      <th>Inv</th>
                      <th>Coverage</th>
                      <th />
                    </tr>
                  </thead>
                  <tbody>
                    {simpleData.generations.map((gen: any) => {
                      const syntaxOk = (gen.metrics?.syntaxErrors || 0) === 0;
                      const multOk =
                        (gen.metrics?.multiplicitiesErrors || 0) === 0;
                      const invOk = (gen.metrics?.invariantsErrors || 0) === 0;
                      const coverage = getAvgCoverage(gen);
                      return (
                        <tr>
                          <td class="gen-name">{gen.id}</td>
                          <td class={syntaxOk ? "status-ok" : "status-error"}>
                            {syntaxOk ? "OK" : gen.metrics?.syntaxErrors}
                          </td>
                          <td class={multOk ? "status-ok" : "status-error"}>
                            {multOk ? "OK" : gen.metrics?.multiplicitiesErrors}
                          </td>
                          <td class={invOk ? "status-ok" : "status-error"}>
                            {invOk ? "OK" : gen.metrics?.invariantsErrors}
                          </td>
                          <td style={getColor(coverage)}>
                            {formatPercent(coverage)}
                          </td>
                          <td>
                            <a
                              href={`/models/${model}/${gen.id}`}
                              class="view-btn"
                            >
                              View
                            </a>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            ) : (
              <p class="no-data">No generation data available</p>
            )}
          </section>
        </div>

        {/* CoT Content */}
        <div class="tab-content" data-content="cot">
          <div class="content-grid">
            <section class="section">
              <h2>Class Diagram</h2>
              <PdfEmbed
                src={modelData.diagramPdf}
                title="Class Diagram"
                height="350px"
                available={true}
              />
            </section>

            <section class="section">
              <h2>Metrics</h2>
              <table class="metrics-table">
                <tbody>
                  <tr>
                    <>
                      <td>Cost</td>
                      <td>${cotData?.price?.price?.toFixed(2) || "—"}</td>
                    </>
                  </tr>
                  <tr>
                    <>
                      <td>Syntax</td>
                      <td>
                        {getValidationRate(
                          cotData?.generations,
                          "syntaxErrors"
                        )}
                      </td>
                    </>
                  </tr>
                  <tr>
                    <>
                      <td>Multiplicities</td>
                      <td>
                        {getValidationRate(
                          cotData?.generations,
                          "multiplicitiesErrors"
                        )}
                      </td>
                    </>
                  </tr>
                  <tr>
                    <>
                      <td>Invariants</td>
                      <td>
                        {getValidationRate(
                          cotData?.generations,
                          "invariantsErrors"
                        )}
                      </td>
                    </>
                  </tr>
                </tbody>
              </table>

              <h3>Coverage</h3>
              <table class="metrics-table">
                <tbody>
                  <tr>
                    <>
                      <td>Classes</td>
                      <td>
                        {cotData?.coverage?.classes
                          ? formatPercent(cotData.coverage.classes)
                          : "—"}
                      </td>
                    </>
                  </tr>
                  <tr>
                    <>
                      <td>Attributes</td>
                      <td>
                        {cotData?.coverage?.attributes
                          ? formatPercent(cotData.coverage.attributes)
                          : "—"}
                      </td>
                    </>
                  </tr>
                  <tr>
                    <>
                      <td>Relationships</td>
                      <td>
                        {cotData?.coverage?.relationships
                          ? formatPercent(cotData.coverage.relationships)
                          : "—"}
                      </td>
                    </>
                  </tr>
                  <tr>
                    <>
                      <td>Realism</td>
                      <td>
                        {cotData?.judge?.successRate
                          ? formatPercent(cotData.judge.successRate)
                          : "—"}
                      </td>
                    </>
                  </tr>
                </tbody>
              </table>

              <h3>Diversity</h3>
              <table class="metrics-table">
                <tbody>
                  <tr>
                    <>
                      <td>Numeric</td>
                      <td>
                        {cotData?.diversity?.numeric
                          ? formatPercent(cotData.diversity.numeric)
                          : "—"}
                      </td>
                    </>
                  </tr>
                  <tr>
                    <>
                      <td>String Equals</td>
                      <td>
                        {cotData?.diversity?.stringEquals
                          ? formatPercent(cotData.diversity.stringEquals)
                          : "—"}
                      </td>
                    </>
                  </tr>
                  <tr>
                    <>
                      <td>String LV</td>
                      <td>
                        {cotData?.diversity?.stringLv
                          ? formatPercent(cotData.diversity.stringLv)
                          : "—"}
                      </td>
                    </>
                  </tr>
                </tbody>
              </table>
            </section>
          </div>

          {cotData?.grakel?.values?.length > 0 && (
            <section class="section">
              <h2>Grakel Similarity</h2>
              <HeatmapMatrix
                labels={cotData.grakel.labels}
                values={cotData.grakel.values}
              />
            </section>
          )}

          {cotData?.shannon?.length > 0 && (
            <section class="section">
              <h2>Shannon Entropy</h2>
              <ShannonBars data={cotData.shannon} />
            </section>
          )}

          <section class="section">
            <h2>Generations</h2>
            {cotData?.generations ? (
              <div class="table-wrapper">
                <table class="gen-table">
                  <thead>
                    <tr>
                      <th>Gen</th>
                      {COT_CATEGORIES.map((cat) => (
                        <th>{cat}</th>
                      ))}
                      <th />
                    </tr>
                  </thead>
                  <tbody>
                    {cotData.generations.map((gen: any) => (
                      <tr>
                        <td class="gen-name">{gen.id}</td>
                        {COT_CATEGORIES.map((cat) => {
                          const catData = gen.categories?.find(
                            (c: any) => c.category === cat
                          );
                          const hasCode = !!catData?.code;
                          return (
                            <td class={hasCode ? "status-ok" : "status-na"}>
                              {hasCode ? "OK" : "—"}
                            </td>
                          );
                        })}
                        <td>
                          <a
                            href={`/models/${model}/${gen.id}?type=cot`}
                            class="view-btn"
                          >
                            View
                          </a>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            ) : (
              <p class="no-data">No generation data available</p>
            )}
          </section>
        </div>
      </>
    )
  }
</PageLayout>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const modeBtns = document.querySelectorAll(".mode-btn");
    const contents = document.querySelectorAll(".tab-content[data-content]");
    const gensSections = document.querySelectorAll(".gens-section");

    const params = new URLSearchParams(window.location.search);
    const initialTab = params.get("type") || "simple";

    function setTab(tabName: string) {
      modeBtns.forEach((btn) =>
        btn.classList.toggle(
          "active",
          btn.getAttribute("data-mode") === tabName
        )
      );
      contents.forEach((c) =>
        c.classList.toggle("active", c.getAttribute("data-content") === tabName)
      );
      gensSections.forEach((s) =>
        s.classList.toggle("hidden", s.getAttribute("data-gens") !== tabName)
      );

      const url = new URL(window.location.href);
      tabName === "simple"
        ? url.searchParams.delete("type")
        : url.searchParams.set("type", tabName);
      window.history.replaceState({}, "", url.toString());
    }

    setTab(initialTab);
    modeBtns.forEach((btn) =>
      btn.addEventListener("click", () =>
        setTab(btn.getAttribute("data-mode") || "simple")
      )
    );
  });
</script>
