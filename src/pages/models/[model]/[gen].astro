---
import PageLayout from "../../../components/PageLayout.astro";
import GenerationView from "../../../components/GenerationView.astro";
import {
  MODELS_LOWER,
  COT_CATEGORIES,
  getModelName,
} from "../../../lib/constants";

export function getStaticPaths() {
  const paths: { params: { model: string; gen: string } }[] = [];
  for (const model of MODELS_LOWER) {
    for (let i = 1; i <= 30; i++) {
      paths.push({ params: { model, gen: `gen${i}` } });
    }
  }
  return paths;
}

const { model, gen } = Astro.params;
const modelName = getModelName(model);
const genNum = parseInt(gen.replace("gen", ""));

// Load generation data
let simpleData: any = null;
let cotData: any = null;

try {
  const simpleFiles = import.meta.glob(
    "../../../data/processed/generations/*/simple-*.json",
    { eager: true }
  );
  const cotFiles = import.meta.glob(
    "../../../data/processed/generations/*/cot-*.json",
    { eager: true }
  );

  const simpleKey = Object.keys(simpleFiles).find((key) =>
    key.endsWith(`/${model}/simple-${gen}.json`)
  );
  if (simpleKey) {
    simpleData =
      (simpleFiles[simpleKey] as any).default || simpleFiles[simpleKey];
  }

  if (genNum <= 6) {
    const cotKey = Object.keys(cotFiles).find((key) =>
      key.endsWith(`/${model}/cot-${gen}.json`)
    );
    if (cotKey) {
      cotData = (cotFiles[cotKey] as any).default || cotFiles[cotKey];
    }
  }
} catch (e) {
  console.error("Error loading generation data:", e);
}

const hasCotData = genNum <= 6 && cotData !== null;
---

<PageLayout
  title={`${modelName} / ${gen}`}
  currentModel={modelName}
  currentGen={gen}
  currentPage="generation"
  activeTab="simple"
>
  <Fragment slot="header-right">
    {
      hasCotData && (
        <div class="category-tabs hidden" data-nav="cot">
          {COT_CATEGORIES.map((cat, i) => (
            <button
              type="button"
              class:list={["cat-tab", { active: i === 0 }]}
              data-cat={cat}
            >
              {cat}
            </button>
          ))}
        </div>
      )
    }
  </Fragment>

  {
    !simpleData && !cotData ? (
      <div class="error-state">
        <p>
          No data available for:{" "}
          <strong>
            {modelName} / {gen}
          </strong>
        </p>
        <p>
          Run: <code>npm run preprocess</code>
        </p>
      </div>
    ) : (
      <>
        {/* Simple Content */}
        <div class="tab-content active" data-content="simple">
          <GenerationView data={simpleData} />
        </div>

        {/* CoT Content */}
        {hasCotData && (
          <div class="tab-content" data-content="cot">
            {COT_CATEGORIES.map((cat, i) => {
              const catData = cotData?.categories?.find(
                (c: any) => c.category === cat
              );
              return (
                <div
                  class:list={["cat-content", { active: i === 0 }]}
                  data-cat-content={cat}
                >
                  <GenerationView
                    data={catData}
                    label={cat}
                    showJudge={false}
                  />
                </div>
              );
            })}
          </div>
        )}
      </>
    )
  }
</PageLayout>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const modeBtns = document.querySelectorAll(".mode-btn");
    const contents = document.querySelectorAll(".tab-content[data-content]");
    const navs = document.querySelectorAll(".category-tabs[data-nav]");
    const gensSections = document.querySelectorAll(".gens-section");
    const catTabs = document.querySelectorAll(".cat-tab[data-cat]");
    const catContents = document.querySelectorAll(
      ".cat-content[data-cat-content]"
    );

    const params = new URLSearchParams(window.location.search);
    const initialTab = params.get("type") || "simple";

    function setTab(tabName: string) {
      modeBtns.forEach((btn) =>
        btn.classList.toggle(
          "active",
          btn.getAttribute("data-mode") === tabName
        )
      );
      contents.forEach((c) =>
        c.classList.toggle("active", c.getAttribute("data-content") === tabName)
      );
      navs.forEach((n) => n.classList.toggle("hidden", tabName !== "cot"));
      gensSections.forEach((s) =>
        s.classList.toggle("hidden", s.getAttribute("data-gens") !== tabName)
      );

      const url = new URL(window.location.href);
      tabName === "simple"
        ? url.searchParams.delete("type")
        : url.searchParams.set("type", tabName);
      window.history.replaceState({}, "", url.toString());
    }

    setTab(initialTab);
    modeBtns.forEach((btn) =>
      btn.addEventListener("click", () =>
        setTab(btn.getAttribute("data-mode") || "simple")
      )
    );

    // Category switching
    catTabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        const cat = tab.getAttribute("data-cat");
        catTabs.forEach((t) => t.classList.toggle("active", t === tab));
        catContents.forEach((c) =>
          c.classList.toggle(
            "active",
            c.getAttribute("data-cat-content") === cat
          )
        );
      });
    });
  });
</script>

<script is:inline>
  (function () {
    try {
      if (new URLSearchParams(window.location.search).get("type") === "cot") {
        document
          .querySelector('.tab-content[data-content="simple"]')
          ?.classList.remove("active");
        document
          .querySelector('.tab-content[data-content="cot"]')
          ?.classList.add("active");
        document
          .querySelector('.category-tabs[data-nav="cot"]')
          ?.classList.remove("hidden");
      }
    } catch (e) {}
  })();
</script>
