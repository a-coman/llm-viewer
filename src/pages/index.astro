---
import PageLayout from "../components/PageLayout.astro";
import {
  MODELS,
  getColor,
  formatPercent,
  formatCurrency,
} from "../lib/constants";

let dashboardData: any = null;
let totals: any = null;
let models: any[] = [];

try {
  const data = await import("../data/processed/dashboard.json");
  dashboardData = data.default || data;
  totals = dashboardData.totals;
  models = dashboardData.models || [];
} catch (e) {
  console.error("Failed to load dashboard data:", e);
}

const summaryMetrics = [
  {
    category: "Cost & Validation",
    metrics: [
      {
        label: "Total Cost",
        simple: totals?.simple?.price?.price,
        cot: totals?.cot?.price?.price,
        type: "currency",
        invert: true,
      },
      {
        label: "Syntax Success",
        simple: totals?.simple?.syntax,
        cot: totals?.cot?.syntax,
        type: "percent",
      },
      {
        label: "Multiplicities",
        simple: totals?.simple?.multiplicities,
        cot: totals?.cot?.multiplicities,
        type: "percent",
      },
      {
        label: "Invariants",
        simple: totals?.simple?.invariants,
        cot: totals?.cot?.invariants,
        type: "percent",
      },
    ],
  },
  {
    category: "Coverage",
    metrics: [
      {
        label: "Classes",
        simple: totals?.simple?.coverage?.classes,
        cot: totals?.cot?.coverage?.classes,
        type: "percent",
      },
      {
        label: "Attributes",
        simple: totals?.simple?.coverage?.attributes,
        cot: totals?.cot?.coverage?.attributes,
        type: "percent",
      },
      {
        label: "Relationships",
        simple: totals?.simple?.coverage?.relationships,
        cot: totals?.cot?.coverage?.relationships,
        type: "percent",
      },
    ],
  },
  {
    category: "Diversity",
    metrics: [
      {
        label: "Numeric",
        simple: totals?.simple?.diversity?.numeric,
        cot: totals?.cot?.diversity?.numeric,
        type: "percent",
      },
      {
        label: "String Equals",
        simple: totals?.simple?.diversity?.stringEquals,
        cot: totals?.cot?.diversity?.stringEquals,
        type: "percent",
      },
      {
        label: "String LV",
        simple: totals?.simple?.diversity?.stringLv,
        cot: totals?.cot?.diversity?.stringLv,
        type: "percent",
      },
    ],
  },
  {
    category: "Quality",
    metrics: [
      {
        label: "Realism",
        simple: totals?.simple?.realism,
        cot: totals?.cot?.realism,
        type: "percent",
      },
    ],
  },
];

function getAvgCoverage(cov: any): number | null {
  return cov ? (cov.classes + cov.attributes + cov.relationships) / 3 : null;
}
---

<PageLayout title="Dashboard" currentPage="dashboard" activeTab="simple">
  {
    !dashboardData ? (
      <div class="error-state">
        <p>No data available. Run preprocessing first:</p>
        <code>npm run preprocess</code>
      </div>
    ) : (
      <>
        <section class="section">
          <h2>Summary</h2>
          <div class="table-wrapper">
            <table class="summary-table">
              <thead>
                <tr>
                  <th class="metric-header">Metric</th>
                  <th class="type-header">Simple</th>
                  <th class="type-header">CoT</th>
                </tr>
              </thead>
              <tbody>
                {summaryMetrics.map((group) => (
                  <>
                    <tr class="category-row">
                      <td colspan="3">{group.category}</td>
                    </tr>
                    {group.metrics.map((m) => (
                      <tr>
                        <td class="metric-label">{m.label}</td>
                        <td
                          class="metric-value"
                          style={getColor(
                            m.type === "currency"
                              ? (m.simple || 0) / 10
                              : m.simple || 0,
                            m.invert
                          )}
                        >
                          {m.type === "currency"
                            ? formatCurrency(m.simple)
                            : formatPercent(m.simple)}
                        </td>
                        <td
                          class="metric-value"
                          style={getColor(
                            m.type === "currency"
                              ? (m.cot || 0) / 20
                              : m.cot || 0,
                            m.invert
                          )}
                        >
                          {m.type === "currency"
                            ? formatCurrency(m.cot)
                            : formatPercent(m.cot)}
                        </td>
                      </tr>
                    ))}
                  </>
                ))}
              </tbody>
            </table>
          </div>
        </section>

        <section class="section">
          <h2>Model Comparison</h2>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th rowspan="2" class="sticky-col">
                    Model
                  </th>
                  <th colspan="4" class="group-header simple">
                    Simple
                  </th>
                  <th colspan="4" class="group-header cot">
                    CoT
                  </th>
                </tr>
                <tr>
                  <>
                    <th class="simple">Cost</th>
                    <th class="simple">Syntax</th>
                    <th class="simple">Coverage</th>
                    <th class="simple">Realism</th>
                  </>
                  <>
                    <th class="cot">Cost</th>
                    <th class="cot">Syntax</th>
                    <th class="cot">Coverage</th>
                    <th class="cot">Realism</th>
                  </>
                </tr>
              </thead>
              <tbody>
                {models.map((m: any) => (
                  <tr>
                    <td class="model-name sticky-col">
                      <a href={`/models/${m.name.toLowerCase()}`}>{m.name}</a>
                    </td>
                    <td style={getColor(1 - (m.simple?.price || 0) / 10)}>
                      {formatCurrency(m.simple?.price)}
                    </td>
                    <td style={getColor(m.simple?.syntax || 0)}>
                      {formatPercent(m.simple?.syntax)}
                    </td>
                    <td
                      style={getColor(getAvgCoverage(m.simple?.coverage) || 0)}
                    >
                      {formatPercent(getAvgCoverage(m.simple?.coverage))}
                    </td>
                    <td style={getColor(m.simple?.realism || 0)}>
                      {formatPercent(m.simple?.realism)}
                    </td>
                    <td style={getColor(1 - (m.cot?.price || 0) / 20)}>
                      {formatCurrency(m.cot?.price)}
                    </td>
                    <td style={getColor(m.cot?.syntax || 0)}>
                      {formatPercent(m.cot?.syntax)}
                    </td>
                    <td style={getColor(getAvgCoverage(m.cot?.coverage) || 0)}>
                      {formatPercent(getAvgCoverage(m.cot?.coverage))}
                    </td>
                    <td style={getColor(m.cot?.realism || 0)}>
                      {formatPercent(m.cot?.realism)}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </section>
      </>
    )
  }
</PageLayout>

<style>
  .summary-table,
  table {
    width: 100%;
    border-collapse: collapse;
  }

  .summary-table th,
  .summary-table td,
  th,
  td {
    padding: 0.5rem 1rem;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
    font-size: 0.8rem;
  }

  .metric-header,
  .type-header {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    color: #666;
    background: #fafafa;
  }

  .type-header {
    text-align: center;
    width: 25%;
  }

  .category-row td {
    background: #f5f5f5;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #888;
    padding: 0.375rem 1rem;
  }

  .metric-label {
    color: #333;
    padding-left: 1.25rem;
  }
  .metric-value {
    text-align: center;
    font-weight: 500;
    color: #111;
  }

  th {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    color: #666;
    background: #fafafa;
    text-align: center;
  }

  .group-header {
    font-size: 0.7rem;
  }
  .group-header.simple {
    background: #f0f4ff;
    color: #333;
  }
  .group-header.cot {
    background: #f5f0ff;
    color: #333;
  }
  th.simple {
    background: #f8faff;
  }
  th.cot {
    background: #faf8ff;
  }

  .model-name {
    text-align: left;
    font-weight: 500;
  }
  .model-name a {
    color: #0066cc;
    text-decoration: none;
  }
  .model-name a:hover {
    text-decoration: underline;
  }

  td {
    text-align: center;
  }
  tbody tr:hover {
    background: #fafafa;
  }

  .sticky-col {
    position: sticky;
    left: 0;
    background: white;
    z-index: 1;
  }
  tbody tr:hover .sticky-col {
    background: #fafafa;
  }
</style>
