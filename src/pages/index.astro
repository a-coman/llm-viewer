---
import PageLayout from "../layouts/PageLayout.astro";
import DataTable from "../components/DataTable.astro";
import MetricsPanel from "../components/MetricsPanel.astro";
import { getDashboardData, getExperimentIds } from "../lib/data";

const experimentId = Astro.url.searchParams.get("experimentId") || "";
const dashboardData = getDashboardData(experimentId);
const { totals, models } = dashboardData || {};

const experimentIds = getExperimentIds();
const currentExperimentId = experimentId || experimentIds[0]; // Default to first matches data logic

const summarySections = {
  cost: true,
  validation: true,
  coverage: true,
  instantiation: false,
  diversity: true,
  quality: true,
};
---

<PageLayout
  title="Dashboard"
  currentPage="dashboard"
  activeTab="simple"
  experimentId={currentExperimentId}
  experimentIds={experimentIds}
>
  {
    !dashboardData ? (
      <div class="error-state">
        <p>No data available. Run preprocessing first:</p>
        <code>npm run preprocess</code>
      </div>
    ) : (
      <>
        <section class="section">
          <h2>Global Summary</h2>
          <div class="summary-grid">
            <MetricsPanel
              title="Simple"
              metrics={totals.simple}
              showSections={summarySections}
            />
            <MetricsPanel
              title="CoT"
              metrics={totals.cot}
              showSections={summarySections}
            />
          </div>
        </section>

        <section class="section">
          <h2>Simple - Model Comparison</h2>
          <DataTable data={models} type="models" mode="simple" />
        </section>

        <section class="section">
          <h2>CoT - Model Comparison</h2>
          <DataTable data={models} type="models" mode="cot" />
        </section>
      </>
    )
  }
</PageLayout>

<style>
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .hidden {
    display: none;
  }
</style>
