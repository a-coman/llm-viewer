---
import PageLayout from "../layouts/PageLayout.astro";
import DataTable from "../components/DataTable.astro";
import MetricsPanel from "../components/MetricsPanel.astro";
import { getDashboardData } from "../lib/data";

const dashboardData = getDashboardData();
const { totals, models } = dashboardData || {};

const summarySections = {
  cost: true,
  validation: true,
  coverage: true,
  instantiation: false,
  diversity: true,
  quality: true,
};
---

<PageLayout title="Dashboard" currentPage="dashboard" activeTab="simple">
  {
    !dashboardData ? (
      <div class="error-state">
        <p>No data available. Run preprocessing first:</p>
        <code>npm run preprocess</code>
      </div>
    ) : (
      <>
        <section class="section">
          <h2>Global Summary</h2>
          <div class="summary-grid">
            <MetricsPanel
              title="Simple Mode Totals"
              metrics={totals.simple}
              showSections={summarySections}
            />
            <MetricsPanel
              title="CoT Mode Totals"
              metrics={totals.cot}
              showSections={summarySections}
            />
          </div>
        </section>

        <section class="section comparison-section" data-mode="simple">
          <h2>Simple - Model Comparison</h2>
          <DataTable data={models} type="models" mode="simple" />
        </section>

        <section class="section comparison-section hidden" data-mode="cot">
          <h2>CoT - Model Comparison</h2>
          <DataTable data={models} type="models" mode="cot" />
        </section>
      </>
    )
  }
</PageLayout>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const tabBtns = document.querySelectorAll(".tab-btn");
    const sections = document.querySelectorAll(".comparison-section");
    const sidebarModeBtns = document.querySelectorAll(".mode-btn");

    function setMode(mode: string) {
      tabBtns.forEach((btn) => {
        btn.classList.toggle("active", btn.getAttribute("data-mode") === mode);
      });
      sections.forEach((section) => {
        section.classList.toggle(
          "hidden",
          section.getAttribute("data-mode") !== mode
        );
      });
      sidebarModeBtns.forEach((btn) => {
        if (btn.getAttribute("data-mode") === mode) {
          (btn as HTMLElement).click();
        }
      });
    }

    tabBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        setMode(btn.getAttribute("data-mode") || "simple");
      });
    });

    const params = new URLSearchParams(window.location.search);
    if (params.get("type") === "cot") setMode("cot");
  });
</script>

<style>
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .hidden {
    display: none;
  }
</style>
